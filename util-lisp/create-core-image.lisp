
(defun slurp (filename) 
  (format nil "~{~a~%~}" 
    (with-open-file (s filename)
      (loop for line = (read-line s nil nil)
            while line
            collect line into lines
            finally (return lines)))))

(defun compiler-main ()
  (let (source (pos 0) p (arg1 "") (arg2 "") (arg3 "") (execute t) (result ""))
      (ignore-errors (setf arg1 (elt COMMON-LISP-USER::*posix-argv* 1)))
      (ignore-errors (setf arg2 (elt COMMON-LISP-USER::*posix-argv* 2)))
      (ignore-errors (setf arg3 (elt COMMON-LISP-USER::*posix-argv* 3)))
      (if (sv-eq arg1 "-Clisp")
        (progn
          (setf execute nil)
          (setf arg1 arg2)
          (setf arg2 arg3)
          (setf arg3 "")))

      ;; (format t "[ execute ~a - ~a - ~a - ~a ]~%" execute arg1 arg2 arg3)

      (if (sv-eq arg1 "-e")
          (setf source arg2)
          (setf source (slurp arg1)))
      ;; (format t "~a" source)

      (setf result (concatenate 'string result (format nil "~a~%" "(progn ")))
      (setf result (concatenate 'string result (format nil "~a~%" ";; Do not edit this file - Generated by MiniPerl6 3.0")))
      (setf result (concatenate 'string result (format nil "~a~%" "(in-package mp-Main) (use-package 'common-lisp) (use-package 'mp-Main)")))
      (loop while (< pos (length source)) 
            do (progn
               (setf p (sv-comp_unit (proto-mp-MiniPerl6-Grammar) source pos))
               ;; (format t "~a~%" (sv-perl p))
               (setf result (concatenate 'string result  
                    (format nil "~a~%" (sv-emit_lisp (sv-capture p)))))
               ;; (sv-say (list ";; at source pos: " (sv-to p) " source end: " (length source)))
               (setf pos (sv-to p))))
      (setf result (concatenate 'string result (format nil "~a~%" ")")))
      ;; (format t "~a~%" result)

      (if execute
          (progn
                ;; (format t "eval:~%")
                (in-package mp-Main)
                (ignore-errors (eval (read-from-string result))))
          (format t "~a" result))

      (sb-ext:quit)))

(sb-ext:save-lisp-and-die "mp6-lisp" :toplevel 'compiler-main :executable t )

